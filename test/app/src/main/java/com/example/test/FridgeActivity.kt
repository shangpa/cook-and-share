package com.example.test

import android.content.Intent
import android.content.pm.PackageManager
import android.graphics.Bitmap
import android.net.Uri
import android.os.Bundle
import android.provider.MediaStore
import android.text.Editable
import android.text.TextWatcher
import android.util.Log
import android.util.TypedValue
import android.widget.*
import androidx.activity.result.contract.ActivityResultContracts
import androidx.appcompat.app.AlertDialog
import androidx.appcompat.app.AppCompatActivity
import androidx.core.app.ActivityCompat
import androidx.core.content.ContextCompat
import androidx.core.content.FileProvider
import androidx.recyclerview.widget.LinearLayoutManager
import androidx.recyclerview.widget.RecyclerView
import com.example.test.Utils.TabBarUtils
import com.example.test.adapter.FridgeAdapter
import com.example.test.model.Fridge.FridgeCreateRequest
import com.example.test.model.Fridge.FridgeResponse
import com.example.test.model.Fridge.IngredientData
import com.example.test.model.Fridge.SelectedIngredient
import com.example.test.model.recipt.*
import com.example.test.network.ApiService
import com.example.test.network.GoogleVisionApi
import com.example.test.network.RetrofitInstance
import com.google.gson.Gson
import com.google.gson.JsonObject
import com.google.mlkit.vision.common.InputImage
import com.google.mlkit.vision.text.TextRecognition
import com.google.mlkit.vision.text.latin.TextRecognizerOptions
import kotlinx.coroutines.*
import okhttp3.MediaType.Companion.toMediaTypeOrNull
import okhttp3.MultipartBody
import okhttp3.RequestBody.Companion.toRequestBody
import retrofit2.Call
import retrofit2.Callback
import retrofit2.Response
import retrofit2.Retrofit
import retrofit2.converter.gson.GsonConverterFactory
import java.io.File
import java.text.SimpleDateFormat
import java.util.*

class FridgeActivity : AppCompatActivity() {

    private lateinit var apiService: ApiService
    private var allFridgeList: List<FridgeResponse> = listOf()
    private var currentCategory = "Ï†ÑÏ≤¥"
    private var selectedFridgeIds = mutableSetOf<Long>()
    private lateinit var fridgeAdapter: FridgeAdapter
    private lateinit var imageUri: Uri
    private var displayedFridgeList: List<FridgeResponse> = listOf()

    override fun onCreate(savedInstanceState: Bundle?) {
        super.onCreate(savedInstanceState)

        // üîê Î°úÍ∑∏Ïù∏ Ïó¨Î∂Ä ÌôïÏù∏
        if (App.prefs.token.isNullOrEmpty()) {
            val intent = Intent(this, LoginActivity::class.java)
            intent.flags = Intent.FLAG_ACTIVITY_NEW_TASK or Intent.FLAG_ACTIVITY_CLEAR_TASK
            startActivity(intent)
            return
        }

        setContentView(R.layout.activity_fridge)

        TabBarUtils.setupTabBar(this)

        if (ContextCompat.checkSelfPermission(this, android.Manifest.permission.CAMERA)
            != PackageManager.PERMISSION_GRANTED) {
            ActivityCompat.requestPermissions(this, arrayOf(android.Manifest.permission.CAMERA), 1001)
        }

        apiService = RetrofitInstance.apiService

        findViewById<TextView>(R.id.dayInput).text = SimpleDateFormat("yyyy.MM.dd", Locale.getDefault()).format(Date())

        val categoryAll = findViewById<LinearLayout>(R.id.categoryAll)
        val categoryFridge = findViewById<LinearLayout>(R.id.categoryFridge)
        val categoryFreeze = findViewById<LinearLayout>(R.id.categoryFreeze)
        val categoryRoom = findViewById<LinearLayout>(R.id.categoryRoom)
        val categoryViews = listOf(categoryAll, categoryFridge, categoryFreeze, categoryRoom)

        setCategorySelected(categoryAll, categoryViews)
        categoryViews.forEach { container ->
            container.setOnClickListener {
                setCategorySelected(it as LinearLayout, categoryViews)
            }
        }

        findViewById<TextView>(R.id.fridegeCameraText).setOnClickListener {
            AlertDialog.Builder(this)
                .setTitle("ÏÇ¨ÏßÑ Í∞ÄÏ†∏Ïò§Í∏∞")
                .setItems(arrayOf("Ïπ¥Î©îÎùº Ï¥¨ÏòÅ", "Ïï®Î≤îÏóêÏÑú ÏÑ†ÌÉù","Ïû•Î≥∏ ÏÇ¨ÏßÑÏúºÎ°ú ÏûêÎèô Îì±Î°ù")) { _, which ->
                    when (which) {
                        0 -> {
                            val photoFile = File.createTempFile("ocr_", ".jpg", cacheDir)
                            imageUri = FileProvider.getUriForFile(this, "$packageName.provider", photoFile)
                            takePictureLauncher.launch(imageUri)
                        }
                        1 -> {
                            galleryLauncher.launch("image/*")
                        }
                        2 -> {
                            // Ïû•Î≥∏ ÏÇ¨ÏßÑ Î∂ÑÏÑù (Vision API)
                            val photoFile = File.createTempFile("grocery_", ".jpg", cacheDir)
                            imageUri = FileProvider.getUriForFile(this, "$packageName.provider", photoFile)
                            groceryCameraLauncher.launch(imageUri)
                        }
                    }
                }.show()
        }

        findViewById<RecyclerView>(R.id.fridgeRecyclerView).layoutManager = LinearLayoutManager(this)

        findViewById<LinearLayout>(R.id.fridgeAddBtn).setOnClickListener {
            startActivity(Intent(this, FridgeIngredientActivity::class.java))
        }

        findViewById<LinearLayout>(R.id.recipeRecommendBtn).setOnClickListener {
            val selectedIngredients = allFridgeList.filter { selectedFridgeIds.contains(it.id) }.map {
                SelectedIngredient(
                    name = it.ingredientName,
                    quantity = it.quantity,
                    unit = it.unitDetail,
                    dateLabel = it.dateOption ?: "Ïú†ÌÜµÍ∏∞Ìïú",
                    dateText = it.fridgeDate
                )
            }

            if (selectedIngredients.isEmpty()) {
                Toast.makeText(this, "Ï∂îÏ≤úÌï† Ïû¨Î£åÎ•º ÏÑ†ÌÉùÌï¥Ï£ºÏÑ∏Ïöî!", Toast.LENGTH_SHORT).show()
                return@setOnClickListener
            }

            val allIngredients = allFridgeList.map {
                SelectedIngredient(
                    name = it.ingredientName,
                    quantity = it.quantity,
                    unit = it.unitDetail,
                    dateLabel = it.dateOption ?: "Ïú†ÌÜµÍ∏∞Ìïú",
                    dateText = it.fridgeDate
                )
            }

            val intent = Intent(this, FridgeRecipeActivity::class.java).apply {
                putParcelableArrayListExtra("selectedIngredients", ArrayList(selectedIngredients))
                putParcelableArrayListExtra("allIngredients", ArrayList(allIngredients))
            }
            startActivity(intent)
        }

        findViewById<TextView>(R.id.fridgeDeleteText).setOnClickListener {
            val token = "Bearer ${getTokenFromPreferences()}"
            val deleteTargets = allFridgeList.filter { selectedFridgeIds.contains(it.id) }

            if (deleteTargets.isEmpty()) {
                Toast.makeText(this, "ÏÇ≠Ï†úÌï† Ìï≠Î™©ÏùÑ ÏÑ†ÌÉùÌï¥ Ï£ºÏÑ∏Ïöî.", Toast.LENGTH_SHORT).show()
                return@setOnClickListener
            }

            val ingredientNamesToDelete = deleteTargets.map { it.ingredientName }.distinct()

            ingredientNamesToDelete.forEach { ingredientName ->
                apiService.deleteFridgeByName(ingredientName, token)
                    .enqueue(object : Callback<Void> {
                        override fun onResponse(call: Call<Void>, response: Response<Void>) {
                            if (response.isSuccessful) {
                                Toast.makeText(this@FridgeActivity, "'$ingredientName' ÏÇ≠Ï†ú ÏôÑÎ£å!", Toast.LENGTH_SHORT).show()
                                fetchFridgeData()
                            } else {
                                Toast.makeText(this@FridgeActivity, "'$ingredientName' ÏÇ≠Ï†ú Ïã§Ìå®: ${response.code()}", Toast.LENGTH_SHORT).show()
                            }
                        }

                        override fun onFailure(call: Call<Void>, t: Throwable) {
                            Toast.makeText(this@FridgeActivity, "ÎÑ§Ìä∏ÏõåÌÅ¨ Ïò§Î•ò: ${t.message}", Toast.LENGTH_SHORT).show()
                        }
                    })
            }
        }


        findViewById<TextView>(R.id.fridgeEditText).setOnClickListener {
            if (selectedFridgeIds.size != 1) {
                Toast.makeText(this, "Ìé∏ÏßëÌï† Ìï≠Î™©ÏùÑ ÌïòÎÇò ÏÑ†ÌÉùÌï¥ Ï£ºÏÑ∏Ïöî.", Toast.LENGTH_SHORT).show()
            } else {
                val targetFridge = allFridgeList.find { it.id == selectedFridgeIds.first() }
                if (targetFridge != null) {
                    val intent = Intent(this, FridgeIngredientActivity::class.java).apply {
                        putExtra("ingredientName", targetFridge.ingredientName)
                        putExtra("quantity", targetFridge.quantity.toString())
                        putExtra("unit", targetFridge.unitDetail)
                        putExtra("storageArea", targetFridge.storageArea)
                        putExtra("fridgeDate", targetFridge.fridgeDate)
                        putExtra("dateOption", targetFridge.dateOption)
                        putExtra("fridgeId", targetFridge.id)
                    }
                    startActivity(intent)
                } else {
                    Toast.makeText(this, "ÏÑ†ÌÉùÎêú Ìï≠Î™©Ïùò Îç∞Ïù¥ÌÑ∞Î•º Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§.", Toast.LENGTH_SHORT).show()
                }
            }
        }

        findViewById<EditText>(R.id.fridgeSearchInput).addTextChangedListener(object : TextWatcher {
            override fun afterTextChanged(s: Editable?) {
                filterAndDisplayFridgeItems(currentCategory, s.toString())
            }
            override fun beforeTextChanged(s: CharSequence?, start: Int, count: Int, after: Int) {}
            override fun onTextChanged(s: CharSequence?, start: Int, before: Int, count: Int) {}
        })

        findViewById<ImageView>(R.id.fridgeAllCheckIcon).setOnClickListener {
            val icon = it as ImageView
            val filteredIds = displayedFridgeList.map { it.id }
            val isAllSelected = selectedFridgeIds.containsAll(filteredIds)

            if (isAllSelected) {
                selectedFridgeIds.removeAll(filteredIds)
                icon.setImageResource(R.drawable.ic_fridge_check)
            } else {
                selectedFridgeIds.addAll(filteredIds)
                icon.setImageResource(R.drawable.ic_fridge_checked)
            }

            fridgeAdapter.notifyDataSetChanged()
        }

    }

    override fun onResume() {
        super.onResume()
        fetchFridgeData()
    }

    private fun fetchFridgeData() {
        val token = "Bearer ${getTokenFromPreferences()}"
        CoroutineScope(Dispatchers.IO).launch {
            try {
                val response = apiService.getMyFridges(token)
                withContext(Dispatchers.Main) {
                    if (response.isSuccessful) {
                        allFridgeList = response.body()?.sortedByDescending { it.updatedAt } ?: listOf()
                        filterAndDisplayFridgeItems(currentCategory)
                    } else {
                        Toast.makeText(this@FridgeActivity, "Îç∞Ïù¥ÌÑ∞ Î∂àÎü¨Ïò§Í∏∞ Ïã§Ìå®", Toast.LENGTH_SHORT).show()
                    }
                }
            } catch (e: Exception) {
                val msg = e.message ?: "Ïïå Ïàò ÏóÜÎäî Ïò§Î•ò"
                Log.e("FridgeActivity", "Îç∞Ïù¥ÌÑ∞ Î∂àÎü¨Ïò§Í∏∞ ÏòàÏô∏", e)

                withContext(Dispatchers.Main) {
                    Toast.makeText(this@FridgeActivity, "ÎÑ§Ìä∏ÏõåÌÅ¨ Ïò§Î•ò: $msg", Toast.LENGTH_SHORT).show()
                }
            }
        }
    }

    private fun filterAndDisplayFridgeItems(category: String, keyword: String = "") {
        val filteredList = allFridgeList.filter {
            val categoryMatch = when (category) {
                "ÎÉâÏû•" -> it.storageArea == "ÎÉâÏû•"
                "ÎÉâÎèô" -> it.storageArea == "ÎÉâÎèô"
                "Ïã§Ïò®" -> it.storageArea == "Ïã§Ïò®"
                else -> true
            }
            val keywordMatch = it.ingredientName.contains(keyword, ignoreCase = true)
            categoryMatch && keywordMatch
        }

        // ÎèôÏùº ingredientNameÎÅºÎ¶¨ Î¨∂Ïñ¥ÏÑú quantity Ìï©ÏÇ∞
        val groupedList = filteredList
            .filter { it.ingredientName != null && it.updatedAt != null }
            .groupBy { it.ingredientName!! }
            .map { (name, items) ->
                val latest = items.maxByOrNull { it.updatedAt!! } ?: items.first()
                latest.copy(quantity = items.sumOf { it.quantity })
            }
        fridgeAdapter = FridgeAdapter(
            fridgeList = groupedList,
            selectedIds = selectedFridgeIds,
            onItemClick = { fridge ->
                if (selectedFridgeIds.contains(fridge.id)) {
                    selectedFridgeIds.remove(fridge.id)
                } else {
                    selectedFridgeIds.add(fridge.id)
                }
                fridgeAdapter.notifyDataSetChanged()
            },
            onIconClick = { fridge ->
                val intent = Intent(this@FridgeActivity, FridgeMaterialListActivity::class.java)
                intent.putExtra("ingredientName", fridge.ingredientName) // ‚úÖ ÏàòÏ†ï
                startActivity(intent)
            }
        )

        displayedFridgeList = groupedList
        findViewById<RecyclerView>(R.id.fridgeRecyclerView).adapter = fridgeAdapter
    }

    private fun setCategorySelected(selected: LinearLayout, allCategories: List<LinearLayout>) {
        val textView = selected.getChildAt(0) as? TextView
        currentCategory = textView?.text.toString()
        filterAndDisplayFridgeItems(currentCategory)

        for (container in allCategories) {
            val tv = container.getChildAt(0) as? TextView
            if (container == selected) {
                container.setBackgroundResource(R.drawable.btn_fridge_ct_ck)
                tv?.setTextColor(resources.getColor(R.color.white))
            } else {
                container.setBackgroundResource(R.drawable.btn_fridge_ct)
                tv?.setTextColor(resources.getColor(R.color.black))
            }
        }
    }

    private val takePictureLauncher = registerForActivityResult(ActivityResultContracts.TakePicture()) { success ->
        if (success) {
            val image = InputImage.fromFilePath(this, imageUri)
            val recognizer = TextRecognition.getClient(TextRecognizerOptions.DEFAULT_OPTIONS)
            recognizer.process(image)
                .addOnSuccessListener { visionText ->
                    val text = visionText.text
                    val cleanedText = text.replace(" ", "").replace("\n", "")
                    if (!cleanedText.contains(Regex("[Í∞Ä-Ìû£]"))) {
                        Log.d("OCR_RESULT", "ÌïúÍ∏Ä ÏóÜÏùå, Vision API ÏãúÎèÑ")
                        val bitmap = MediaStore.Images.Media.getBitmap(contentResolver, imageUri)
                        callGoogleVisionAPI(bitmap)
                        return@addOnSuccessListener
                    }
                    handleMatchedText(cleanedText)
                }
                .addOnFailureListener { e ->
                    Log.w("OCR_MLKIT", "ML Kit Ïù∏Ïãù Ïã§Ìå®: ${e.message}, Vision API ÏãúÎèÑ")
                    val bitmap = MediaStore.Images.Media.getBitmap(contentResolver, imageUri)
                    callGoogleVisionAPI(bitmap)
                }
        }
    }

    private fun handleMatchedText(text: String) {
        val knownIngredients = listOf("Í∞êÏûê", "ÍπªÏûé", "ÌñáÍ∞êÏûê", "ÎãπÍ∑º", "ÏñëÌåå", "Í≥ÑÎûÄ", "Ïò§Ïù¥", "ÏÉÅÏ∂î", "ÏãúÍ∏àÏπò")
        val matched = knownIngredients.firstOrNull { text.contains(it) }
        if (matched != null) {
            val intent = Intent(this, FridgeIngredientActivity::class.java).apply {
                putExtra("ingredientName", matched)
            }
            startActivity(intent)
        } else {
            Toast.makeText(this, "ÏùåÏãù Ïû¨Î£åÎ•º Ïù∏ÏãùÌïòÏßÄ Î™ªÌñàÏäµÎãàÎã§.", Toast.LENGTH_SHORT).show()
        }
    }

    private val galleryLauncher = registerForActivityResult(ActivityResultContracts.GetContent()) { uri ->
        uri?.let {
            val bitmap = MediaStore.Images.Media.getBitmap(contentResolver, it)
            callGoogleVisionAPI(bitmap)
        }
    }

    private val cameraLauncher = registerForActivityResult(ActivityResultContracts.TakePicture()) { success ->
        if (success) {
            val bitmap = MediaStore.Images.Media.getBitmap(contentResolver, imageUri)
            callGoogleVisionAPI(bitmap)
        }
    }

    private fun bitmapToBase64(bitmap: Bitmap): String {
        val stream = java.io.ByteArrayOutputStream()
        bitmap.compress(Bitmap.CompressFormat.JPEG, 100, stream)
        val byteArray = stream.toByteArray()
        return android.util.Base64.encodeToString(byteArray, android.util.Base64.NO_WRAP)
    }

    fun callGoogleVisionAPI(bitmap: Bitmap) {
        val base64Image = bitmapToBase64(bitmap)
        val image = Image(content = base64Image)
        val feature = Feature()
        val context = ImageContext(languageHints = listOf("ko"))
        val requestItem = RequestItem(image, listOf(feature), context)
        val request = VisionRequest(listOf(requestItem))

        val gson = Gson()
        val retrofit = Retrofit.Builder()
            .baseUrl("https://vision.googleapis.com/")
            .addConverterFactory(GsonConverterFactory.create())
            .build()

        val service = retrofit.create(GoogleVisionApi::class.java)
        val apiKey = "AIzaSyDQWnQPMzjhZU4h6XZ3R9f8BO3bTwt8at0"
        Log.d("API_KEY_CHECK", "Google Vision API Key: '$apiKey'")
        val call = service.annotateImage(apiKey, request)

        Log.d("VISION_REQUEST_URL", call.request().url.toString())

        call.enqueue(object : Callback<JsonObject> {
            override fun onResponse(call: Call<JsonObject>, response: Response<JsonObject>) {
                if (response.isSuccessful) {
                    val text = response.body()
                        ?.getAsJsonArray("responses")
                        ?.get(0)?.asJsonObject
                        ?.getAsJsonObject("fullTextAnnotation")
                        ?.get("text")?.asString ?: "Í≤∞Í≥º ÏóÜÏùå"
                    Log.d("VISION_REQUEST_URL", call.request().url.toString())
                    Log.d("VISION_RESULT", text)
                    handleDetectedText(text)
                } else {
                    Log.e("VISION_ERROR", "Ïò§Î•ò ÏùëÎãµ: ${response.errorBody()?.string()}")
                }
            }

            override fun onFailure(call: Call<JsonObject>, t: Throwable) {
                Log.e("VISION_ERROR", "ÎÑ§Ìä∏ÏõåÌÅ¨ Ïò§Î•ò", t)
            }
        })
    }


    private fun handleDetectedText(text: String) {
        val dateRegex = Regex("""ÌåêÎß§Ïùº[:\s]+(\d{2,4}[-.]\d{2}[-.]\d{2})""")
        val dateRaw = dateRegex.find(text)?.groupValues?.get(1) ?: ""
        val fridgeDate = if (dateRaw.isNotEmpty()) {
            val parts = dateRaw.split("[-./]".toRegex())
            if (parts[0].length == 2) "20${parts[0]}-${parts[1]}-${parts[2]}" else dateRaw
        } else {
            SimpleDateFormat("yyyy-MM-dd", Locale.getDefault()).format(Date())
        }

        val lines = text.lines()
        val items = mutableListOf<FridgeCreateRequest>()

        // Ïó¨Í∏∞ÏÑú itemHeaderRegex ÏÑ†Ïñ∏
        val itemHeaderRegex = Regex("""\d{3}\s+([Í∞Ä-Ìû£]+)""")  // Ïòà: 001 ÌñáÍ∞êÏûê

        var index = 0
        while (index < lines.size - 1) {
            val line = lines[index].trim()
            val matchedName = itemHeaderRegex.find(line)?.groupValues?.get(1)

            if (matchedName != null && isValidIngredientName(matchedName)) {
                // Îã§Ïùå Ï§Ñ(ÏÉÅÌíàÏΩîÎìú, Îã®Í∞Ä, ÏàòÎüâ Îì± Ìè¨Ìï®Îêú Ï§Ñ)ÏùÑ Î∂ÑÏÑù
                val nextLine = lines.getOrNull(index + 1)?.trim() ?: ""
                val tokens = nextLine.split(Regex("""\s+"""))  // Í≥µÎ∞± Í∏∞Ï§Ä split

                // ÎßàÏßÄÎßâÏóêÏÑú Îëê Î≤àÏß∏ Í∞íÏùÑ ÏàòÎüâÏúºÎ°ú ÏÇ¨Ïö© (Ïòà: 1,930 1 1,930)
                val quantity = if (tokens.size >= 3) {
                    tokens[tokens.size - 2].replace(",", "").toDoubleOrNull() ?: 1.0
                } else 1.0

                items.add(
                    FridgeCreateRequest(
                        ingredientName = matchedName,
                        quantity = quantity,
                        fridgeDate = fridgeDate,
                        dateOption = "Íµ¨Îß§ÏùºÏûê",
                        storageArea = "Ïã§Ïò®",
                        unitDetail = "Í∞ú",
                        unitCategory = "COUNT"
                    )
                )
                index += 2  // ÏÉÅÌíàÎ™Ö Ï§Ñ + Í∞ÄÍ≤© Ï§Ñ Í±¥ÎÑàÎõ∞Í∏∞
            } else {
                index++
            }
        }

        if (items.isEmpty()) {
            Toast.makeText(this, "Ïù∏ÏãùÎêú Ïû¨Î£åÍ∞Ä ÏóÜÏäµÎãàÎã§.", Toast.LENGTH_SHORT).show()
            return
        }
        saveItemsToServerSequentially(items)
    }
    private fun saveItemsToServerSequentially(items: List<FridgeCreateRequest>, index: Int = 0) {
        if (index >= items.size) {
            Log.d("OCR_SAVE_DEBUG", "Î™®Îì† ÏïÑÏù¥ÌÖú Ï†ÄÏû• ÏôÑÎ£å")
            fetchFridgeData()
            return
        }

        val token = "Bearer ${App.prefs.token}"
        val api = RetrofitInstance.apiService
        val item = items[index]

        Log.d("OCR_SAVE_DEBUG", "ÏïÑÏù¥ÌÖú ${index} Ï†ÄÏû• ÏãúÎèÑ: ${item.ingredientName}")

        api.createFridgeByOCR(item, token).enqueue(object : Callback<Void> {
            override fun onResponse(call: Call<Void>, response: Response<Void>) {
                if (response.isSuccessful) {
                    Log.d("OCR_SAVE_DEBUG", "ÏïÑÏù¥ÌÖú ${index} Ï†ÄÏû• ÏôÑÎ£å: ${item.ingredientName}")
                    saveItemsToServerSequentially(items, index + 1)  // Ïû¨Í∑Ä Ìò∏Ï∂ú
                } else {
                    Log.e("OCR_SAVE_DEBUG", "ÏïÑÏù¥ÌÖú ${index} Ï†ÄÏû• Ïã§Ìå® ÏΩîÎìú: ${response.code()}")
                }
            }
            override fun onFailure(call: Call<Void>, t: Throwable) {
                val message = t.message ?: "Ïïå Ïàò ÏóÜÎäî ÎÑ§Ìä∏ÏõåÌÅ¨ Ïò§Î•ò"
                Log.e("OCR_SAVE_DEBUG", "ÏïÑÏù¥ÌÖú $index Ï†ÄÏû• Ïã§Ìå® ÏóêÎü¨: $message", t)
                runOnUiThread {
                    Toast.makeText(this@FridgeActivity, "ÎÑ§Ìä∏ÏõåÌÅ¨ Ïò§Î•ò: $message", Toast.LENGTH_SHORT).show()
                }
            }

        })
    }

    fun isValidIngredientName(name: String): Boolean {
        val excludedWords = listOf("Í≥ÑÏÇ∞Ïõê", "Í≥†Í∞ù", "Ïπ¥Îìú", "ÏòÅÏàòÏ¶ù", "Í∂åÎØ∏Í≤Ω", "Ïã†Ïö©Ïπ¥Îìú", "ÌåêÎß§Ïùº")
        if (name.length !in 2..6) return false
        if (excludedWords.any { name.contains(it) }) return false
        return true
    }


    private fun parseItem(lines: List<String>, date: String): IngredientData? {
        // 1. Ïû¨Î£åÎ™Ö Ï∞æÍ∏∞: ÌïúÍ∏ÄÎ°ú Îêú Îã®Ïñ¥ Ï§ë Í∞ÄÏû• Î®ºÏ†Ä ÎÇòÏò§Îäî Í±∏ Ïù¥Î¶ÑÏúºÎ°ú ÏÇ¨Ïö©
        val name = lines.firstOrNull { it.contains(Regex("[Í∞Ä-Ìû£]+")) }?.trim() ?: return null

        // 2. ÏàòÎüâ Ï∞æÍ∏∞: Ïà´ÏûêÎßå ÏûàÎäî Ï§ÑÏù¥ÎÇò, '1' ÎòêÎäî '2' Í∞ôÏùÄ Îã®Ïàú Ïà´ÏûêÎ•º Ïö∞ÏÑ† Ï∞æÍ∏∞
        val quantityLine = lines.firstOrNull { it.trim().matches(Regex("""\d+""")) }
        val quantity = quantityLine?.toIntOrNull() ?: 1

        return IngredientData(name, quantity.toString(), date)
    }


    private fun getTokenFromPreferences(): String {
        return App.prefs.token ?: ""
    }

    private fun dpToPx(dp: Int): Int {
        return TypedValue.applyDimension(
            TypedValue.COMPLEX_UNIT_DIP,
            dp.toFloat(),
            resources.displayMetrics
        ).toInt()
    }
    private val groceryCameraLauncher =
        registerForActivityResult(ActivityResultContracts.TakePicture()) { success ->
            val token = App.prefs.token ?: ""
            if (success) {
                imageUri?.let { uri ->
                    val inputStream = contentResolver.openInputStream(uri)
                    val requestBody = inputStream?.readBytes()
                        ?.let { bytes -> bytes.toRequestBody("image/*".toMediaTypeOrNull()) }

                    val multipart = requestBody?.let {
                        MultipartBody.Part.createFormData("image", "grocery.jpg", it)
                    }

                    multipart?.let {
                        RetrofitInstance.apiService.detectAndSaveIngredients("Bearer $token", it)
                            .enqueue(object : Callback<List<String>> {
                                override fun onResponse(call: Call<List<String>>, response: Response<List<String>>) {
                                    if (response.isSuccessful) {
                                        val items = response.body() ?: emptyList()
                                        if (items.isNotEmpty()) {
                                            val intent = Intent(this@FridgeActivity, FridgeIngredientActivity::class.java)
                                            intent.putExtra("ingredientName", items[0])
                                            intent.putExtra("fridgeDate", getTodayDate())
                                            startActivity(intent)
                                        } else {
                                            Toast.makeText(this@FridgeActivity, "Ïù∏ÏãùÎêú Ïû¨Î£åÍ∞Ä ÏóÜÏäµÎãàÎã§.", Toast.LENGTH_SHORT).show()
                                        }
                                    } else {
                                        Toast.makeText(this@FridgeActivity, "Ï†ÄÏû• Ïã§Ìå®", Toast.LENGTH_SHORT).show()
                                    }
                                }

                                override fun onFailure(call: Call<List<String>>, t: Throwable) {
                                    Toast.makeText(this@FridgeActivity, "Ïò§Î•ò Î∞úÏÉù: ${t.message}", Toast.LENGTH_SHORT).show()
                                }
                            })
                    }
                }
            }
        }

    private fun getTodayDate(): String {
        return SimpleDateFormat("yyyy-MM-dd", Locale.getDefault()).format(Date())
    }
}
